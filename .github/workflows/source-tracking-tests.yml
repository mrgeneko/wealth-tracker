name: Source Tracking Integration Tests

on:
  push:
    branches: [ main, docs/source-tracking-documentation ]
    paths:
      - 'tests/integration/source-tracking.integration.test.js'
      - 'scripts/migrations/001-add-source-tracking-columns.sql'
      - 'scripts/migrations/002-add-ticker-registry-source-tracking.sql'
      - 'services/price-router.js'
      - 'dashboard/server.js'
      - 'api/positions.js'
      - '.github/workflows/source-tracking-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'tests/integration/source-tracking.integration.test.js'
      - 'scripts/migrations/001-add-source-tracking-columns.sql'
      - 'scripts/migrations/002-add-ticker-registry-source-tracking.sql'
      - 'services/price-router.js'
      - 'dashboard/server.js'
      - 'api/positions.js'

# Required for dorny/test-reporter to create check runs
permissions:
  contents: read
  actions: read
  checks: write

jobs:
  source-tracking-tests:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
          MYSQL_USER: test
          MYSQL_PASSWORD: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: 3306
      MYSQL_DATABASE: testdb
      MYSQL_USER: test
      MYSQL_PASSWORD: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y default-mysql-client

      - name: Install npm dependencies
        run: npm ci

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot -e 'SELECT 1' && break || sleep 2
          done

      - name: Initialize base schema
        run: |
          echo "Creating base schema tables..."
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE < scripts/init-db/000-base-schema.sql
          echo "Verifying base tables were created..."
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE -e "SHOW TABLES LIKE 'positions';"

      - name: Apply source tracking migrations
        run: |
          echo "Applying source tracking migrations..."
          echo "Migration 1: Add source tracking columns to positions table"
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE < scripts/migrations/001-add-source-tracking-columns.sql

          echo "Migration 2: Add pricing_provider to ticker_registry"
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE < scripts/migrations/002-add-ticker-registry-source-tracking.sql

          echo "Verifying source tracking columns exist..."
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE -e "DESCRIBE positions;" | grep -E "(security_type|source|pricing_provider)"
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE -e "DESCRIBE ticker_registry;" | grep -E "(pricing_provider|display_name)"

      - name: Create test account
        run: |
          echo "Creating test account for integration tests..."
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE << 'EOF'
          INSERT INTO accounts (id, name, account_type_id) VALUES (1, 'Test Account', 1)
          ON DUPLICATE KEY UPDATE name = VALUES(name);
          EOF

      - name: Run source tracking integration tests
        run: |
          rm -rf artifacts/test-results
          mkdir -p artifacts/test-results
          node scripts/ci/run_tests_with_junit.js --outdir=artifacts/test-results --testsdir=tests/integration --include=source-tracking.integration.test.js

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: source-tracking-test-results
          path: artifacts/test-results/

      - name: Publish test results (JUnit)
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Source Tracking Integration Tests
          path: artifacts/test-results/source-tracking*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Generate test summary
        if: always()
        run: |
          echo "=== SOURCE TRACKING INTEGRATION TEST RESULTS ==="
          echo ""
          echo "Test Coverage:"
          echo "✅ Position CRUD with source/pricing_provider"
          echo "✅ Multi-type ticker support (same ticker, different security types)"
          echo "✅ Price fetching with pricing_provider specification"
          echo "✅ Asset retrieval with source tracking metadata"
          echo "✅ Database schema with source tracking columns"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ ALL SOURCE TRACKING TESTS PASSING"
            echo "   Source tracking implementation is ready for production"
          else
            echo "❌ SOME SOURCE TRACKING TESTS FAILED"
            echo "   Review test failures and fix implementation"
          fi
          echo ""
          echo "Database Schema Verification:"
          mysql -h $MYSQL_HOST -P $MYSQL_PORT -u root -proot $MYSQL_DATABASE -e "
            SELECT 'positions table columns:' as info;
            DESCRIBE positions;
            SELECT '' as separator;
            SELECT 'ticker_registry table columns:' as info;
            DESCRIBE ticker_registry;
          " 2>/dev/null | head -50