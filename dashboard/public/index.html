<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Tracker Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #121212; color: #e0e0e0; }
        h1, h2 { color: #ffffff; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Grid Styles */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #1e1e1e; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        th, td { padding: 10px; border: 1px solid #333; text-align: right; color: #e0e0e0; }
        th { background-color: #2d2d2d; font-weight: bold; text-align: center; color: #ffffff; }
        td:first-child, th:first-child { text-align: left; }
        
        /* Buttons */
        .btn { padding: 8px 12px; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .btn-primary { background-color: #0d6efd; color: white; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #bb2d3b; }
        
        /* Section Headers */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 10px; }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #2d2d2d; margin: 10% auto; padding: 20px; border: 1px solid #444; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); color: #e0e0e0; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #e0e0e0; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #555; border-radius: 4px; background-color: #333; color: #fff; }
        
        /* Clickable Cells */
        .clickable-cell { cursor: pointer; color: #6ea8fe; text-decoration: none; display: block; width: 100%; height: 100%; }
        .clickable-cell:hover { text-decoration: underline; background-color: #2c3e50; }
        .edit-icon { font-size: 0.8em; margin-left: 5px; color: #888; visibility: hidden; }
        .clickable-cell:hover .edit-icon { visibility: visible; }
        
        .row-total { font-weight: bold; background-color: #252525; }
        .total-row td { font-weight: bold; background-color: #333; border-top: 2px solid #555; }
        
        .positive { color: #4caf50; }
        .negative { color: #f44336; }

        /* Tabs */
        .tab { overflow: hidden; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; color: #aaa; }
        .tab button:hover { background-color: #333; color: white; }
        .tab button.active { background-color: #2d2d2d; color: white; border-bottom: 2px solid #0d6efd; }
        .tab-content { display: none; animation: fadeEffect 1s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        /* Log Table Overrides */
        #log-table th:first-child, 
        #log-table td:first-child {
            position: static !important;
            background-color: transparent !important;
            z-index: auto !important;
        }

        /* Icon Button */
        .icon-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            color: #0d6efd;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            width: 36px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .icon-btn:hover {
            background-color: rgba(13, 110, 253, 0.1);
        }

        .plus-icon {
            font-weight: bold;
            line-height: 1;
            display: inline-block;
            transition: transform 0.3s;
        }

        .icon-btn:hover .plus-icon {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wealth Tracker Dashboard</h1>
        <div id="last-updated" style="color: #aaa; font-size: 0.9em; margin-bottom: 20px;"></div>

        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'Accounts')">Accounts</button>
            <button class="tablinks" onclick="openTab(event, 'Historical')">Historical Values</button>
            <button class="tablinks" onclick="openTab(event, 'Projections')">Projections</button>
            <button class="tablinks" onclick="openTab(event, 'Logs')">Logs</button>
        </div>

        <div id="Accounts" class="tab-content" style="display: block;">
            <!-- Investment Accounts -->
            <div class="section-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <span>Investment Accounts</span>
                    <button class="icon-btn" title="Add Account" onclick="openAccountModal('investment')">
                        <span class="plus-icon">+</span>
                    </button>
                </h2>
            </div>
            <table id="investment-grid">
                <thead></thead>
                <tbody></tbody>
            </table>

            <!-- Bank Accounts -->
            <div class="section-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <span>Bank Accounts</span>
                    <button class="icon-btn" title="Add Account" onclick="openAccountModal('bank')">
                        <span class="plus-icon">+</span>
                    </button>
                </h2>
            </div>
            <table id="bank-grid">
                <thead></thead>
                <tbody></tbody>
            </table>

            <!-- Fixed Assets -->
            <div class="section-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <span>Fixed Assets</span>
                    <button class="icon-btn" title="Add Asset" onclick="openAssetModal()">
                        <span class="plus-icon">+</span>
                    </button>
                </h2>
            </div>
            <table id="asset-grid">
                <thead></thead>
                <tbody></tbody>
            </table>

            <div id="total-net-worth" style="font-size: 1.5em; font-weight: bold; margin-top: 30px; margin-bottom: 20px;"></div>
        </div>

        <div id="Historical" class="tab-content">
            <h2>Historical Values</h2>
            <p>Historical data visualization coming soon.</p>
        </div>

        <div id="Projections" class="tab-content">
            <h2>Projections</h2>
            <p>Future wealth projections coming soon.</p>
        </div>

        <div id="Logs" class="tab-content">
            <h2>System Logs</h2>
            <div id="logs-container" style="display: flex; height: 600px; border: 1px solid #444;">
                <div id="log-list-pane" style="width: 50%; min-width: 150px; overflow-y: auto; overflow-x: auto; background: #1e1e1e;">
                    <table id="log-table" style="width: 100%; font-size: 0.8em; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th id="col-file" style="text-align: left; padding: 5px; position: relative;">File</th>
                                <th id="col-time" style="text-align: left; padding: 5px; width: 132px; white-space: nowrap;">Time</th>
                                <th id="col-size" style="text-align: right; padding: 5px; width: 70px; white-space: nowrap;">Size</th>
                            </tr>
                        </thead>
                        <tbody id="log-list"></tbody>
                    </table>
                </div>
                <div id="pane-resizer" style="width: 5px; cursor: col-resize; background-color: #444; user-select: none; z-index: 10;"></div>
                <div id="log-viewer-pane" style="flex: 1; min-width: 150px; overflow-y: auto; padding: 10px; background: #121212; font-family: monospace; white-space: pre-wrap;">
                    Select a log file to view...
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="width: 350px;">
            <h2 id="confirmModalTitle">Confirm</h2>
            <p id="confirmModalMessage" style="margin-bottom: 20px;"></p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn" style="background-color: #555; color: white;" onclick="closeModal('confirmModal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalOk">Delete</button>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('accountModal')">&times;</span>
            <h2 id="accountModalTitle">Add Account</h2>
            <form id="accountForm">
                <input type="hidden" id="accId">
                <input type="hidden" id="accCategory">
                <div class="form-group">
                    <label for="accName">Account Name</label>
                    <input type="text" id="accName" required>
                </div>
                <div class="form-group">
                    <label for="accType">Type</label>
                    <input type="text" id="accType" placeholder="e.g., 401k, Roth IRA, Checking">
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-danger" id="btnDeleteAccount" style="display:none;" onclick="deleteAccount()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Position Modal -->
    <div id="positionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('positionModal')">&times;</span>
            <h2 id="positionModalTitle">Edit Position</h2>
            <form id="positionForm">
                <input type="hidden" id="posId">
                <input type="hidden" id="posAccountId">
                <div class="form-group" id="posSymbolGroup">
                    <label for="posSymbol">Symbol</label>
                    <input type="text" id="posSymbol" required>
                </div>
                <div class="form-group">
                    <div id="posTypeGroup">
                        <label for="posType">Type</label>
                        <select id="posType">
                            <option value="stock">Stock</option>
                            <option value="etf">ETF</option>
                            <option value="bond">Bond</option>
                            <option value="cash">Cash</option>
                            <option value="crypto">Crypto</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="posQuantity">Quantity</label>
                    <input type="number" step="any" id="posQuantity" required>
                    <small style="color: #aaa;">For Cash, enter the total value.</small>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-danger" id="btnDeletePosition" style="display:none;" onclick="deletePosition()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Asset Modal -->
    <div id="assetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assetModal')">&times;</span>
            <h2 id="assetModalTitle">Add Asset</h2>
            <form id="assetForm">
                <input type="hidden" id="assetId">
                <div class="form-group">
                    <label for="assetName">Name</label>
                    <input type="text" id="assetName" required>
                </div>
                <div class="form-group">
                    <label for="assetType">Type</label>
                    <select id="assetType">
                        <option value="real_estate">Real Estate</option>
                        <option value="vehicle">Vehicle</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetValue">Value</label>
                    <input type="number" step="any" id="assetValue" required>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-danger" id="btnDeleteAsset" style="display:none;" onclick="deleteAsset()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const socket = io();
        let currentPrices = {};
        let lastAssetsData = null;

        // --- Socket.IO Listeners ---
        socket.on('price_update', (data) => {
            console.log('Price update received');
            currentPrices = data;
            if (lastAssetsData) renderAll();
        });

        socket.on('assets_update', (data) => {
            console.log('Assets update received');
            fetchAssets();
        });

        // --- Data Fetching ---
        async function fetchAssets() {
            try {
                const response = await fetch('/api/assets');
                const data = await response.json();
                lastAssetsData = data;
                renderAll();
            } catch (error) {
                console.error('Error fetching assets:', error);
            }
        }

        // --- Rendering ---
        function renderAll() {
            if (!lastAssetsData) return;

            // Filter accounts
            const investmentAccounts = lastAssetsData.accounts.filter(a => a.category === 'investment' || !a.category);
            const bankAccounts = lastAssetsData.accounts.filter(a => a.category === 'bank');
            
            // Combine fixed assets
            const fixedAssets = [
                ...(lastAssetsData.real_estate || []).map(a => ({...a, type: 'real_estate'})),
                ...(lastAssetsData.vehicles || []).map(a => ({...a, type: 'vehicle'}))
            ];

            renderInvestmentGrid('investment-grid', investmentAccounts);
            renderBankGrid('bank-grid', bankAccounts);
            renderAssetGrid('asset-grid', fixedAssets);

            // Calculate Net Worth
            let netWorth = 0;
            // Add fixed assets
            fixedAssets.forEach(a => netWorth += a.value);
            // Add accounts (calculated in render functions, but we can re-calc here or grab from DOM)
            // Let's re-calc for accuracy
            lastAssetsData.accounts.forEach(acc => {
                if (acc.holdings.cash) netWorth += acc.holdings.cash.value;
                acc.holdings.stocks.forEach(p => {
                    const price = currentPrices[p.symbol]?.price || 0;
                    netWorth += p.quantity * price;
                });
                acc.holdings.bonds.forEach(p => {
                    // Assuming bonds are valued at face value or quantity for now if no price
                    // Or if we have a price source for bonds
                    netWorth += p.quantity; 
                });
            });

            document.getElementById('total-net-worth').innerText = `Total Net Worth: $${formatNumber(netWorth)}`;
            document.getElementById('last-updated').innerText = `Last Updated: ${new Date().toLocaleString()}`;
        }

        function renderInvestmentGrid(tableId, accounts) {
            const gridTable = document.getElementById(tableId);
            const thead = gridTable.querySelector('thead');
            const tbody = gridTable.querySelector('tbody');

            if (!accounts || accounts.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td>No accounts found. Add one to get started.</td></tr>';
                return;
            }

            // Collect all unique symbols
            const allSymbols = new Set();
            accounts.forEach(acc => {
                acc.holdings.stocks.forEach(pos => allSymbols.add(pos.symbol));
                acc.holdings.bonds.forEach(pos => allSymbols.add(pos.symbol));
            });
            const sortedSymbols = Array.from(allSymbols).sort();

            // Header
            let headerHtml = '<tr><th style="text-align: left">Symbol</th>';
            accounts.forEach(acc => {
                const accJson = escapeHtml(JSON.stringify(acc));
                const accType = acc.type ? acc.type.toUpperCase() : '';
                headerHtml += `<th style="text-align: center"><span class="clickable-cell" onclick="openAccountModal(null, ${accJson})">${acc.name}<br><small style="font-weight: normal; color: #aaa;">${accType}</small> <span class="edit-icon">✎</span></span></th>`;
            });
            headerHtml += '<th>Price</th><th>Change</th><th>Change %</th><th>Time</th><th>Source</th><th>Value Change</th><th>Total</th></tr>';
            thead.innerHTML = headerHtml;

            let bodyHtml = '';
            let grandTotalValueChange = 0;

            // Symbol Rows
            sortedSymbols.forEach(sym => {
                let price = 0;
                let changePct = '0%';
                let changeVal = 0;
                let timeStr = '-';
                let sourceStr = '-';
                let color = '#e0e0e0';
                
                if (currentPrices[sym]) {
                    price = currentPrices[sym].price;
                    changePct = currentPrices[sym].change_percent || '0%';
                    changeVal = currentPrices[sym].change || 0;
                    
                    if (currentPrices[sym].time) {
                        const d = new Date(currentPrices[sym].time);
                        if (!isNaN(d.getTime())) {
                            timeStr = d.toLocaleString();
                        } else {
                            timeStr = currentPrices[sym].time;
                        }
                    }
                    
                    sourceStr = currentPrices[sym].source || '-';
                    if (changeVal > 0) color = '#4caf50';
                    if (changeVal < 0) color = '#f44336';
                }

                let rowHtml = `<tr><td style="text-align: left; font-weight: bold;">${sym}</td>`;
                
                let symTotalValue = 0;
                let symTotalValueChange = 0;

                accounts.forEach(acc => {
                    // Find position in stocks or bonds
                    let pos = acc.holdings.stocks.find(p => p.symbol === sym);
                    let isBond = false;
                    if (!pos) {
                        pos = acc.holdings.bonds.find(p => p.symbol === sym);
                        if (pos) isBond = true;
                    }
                    
                    if (pos) {
                        let calcPrice = price;
                        let calcChange = changeVal;
                        if (isBond) {
                            calcPrice = price / 100.0;
                            calcChange = changeVal / 100.0;
                        }
                        
                        const value = pos.quantity * calcPrice;
                        symTotalValue += value;
                        symTotalValueChange += pos.quantity * calcChange;
                        const posType = isBond ? 'bond' : 'stock';
                        const posData = { id: pos.id, account_id: acc.id, symbol: pos.symbol, type: posType, quantity: pos.quantity };
                        const posJson = escapeHtml(JSON.stringify(posData));
                        rowHtml += `<td><span class="clickable-cell" onclick="openPositionModal(${posJson})">${formatNumber(value)}<br><small>${pos.quantity.toFixed(0)}</small></span></td>`;
                    } else {
                        const addPosData = { account_id: acc.id, symbol: sym, type: 'stock', quantity: 0 };
                        const addPosJson = escapeHtml(JSON.stringify(addPosData));
                        rowHtml += `<td><span class="clickable-cell" style="color: #555; text-align: center;" onclick="openPositionModal(${addPosJson})">+</span></td>`;
                    }
                });
                
                rowHtml += `<td>${formatNumber(price)}</td>`;
                rowHtml += `<td style="color: ${color}">${formatNumber(changeVal)}</td>`;
                rowHtml += `<td style="color: ${color}">${changePct}</td>`;
                rowHtml += `<td style="font-size: 0.8em; color: #aaa;">${timeStr}</td>`;
                rowHtml += `<td style="font-size: 0.8em; color: #aaa;">${sourceStr}</td>`;
                grandTotalValueChange += symTotalValueChange;
                rowHtml += `<td style="color: ${color}">${formatNumber(symTotalValueChange)}</td>`;
                rowHtml += `<td class="row-total">${formatNumber(symTotalValue, 0)}</td></tr>`;
                bodyHtml += rowHtml;
            });

            // Cash Row
            let cashRowHtml = '<tr><td style="text-align: left; font-weight: bold;">CASH</td>';
            let totalCash = 0;
            accounts.forEach(acc => {
                let cashVal = 0;
                let cashPos = acc.holdings.cash;
                if (cashPos) {
                    cashVal = cashPos.value;
                    const posData = { id: cashPos.id, account_id: acc.id, symbol: 'CASH', type: 'cash', quantity: cashVal };
                    const posJson = escapeHtml(JSON.stringify(posData));
                    cashRowHtml += `<td><span class="clickable-cell" onclick="openPositionModal(${posJson})">${formatNumber(cashVal)}</span></td>`;
                } else {
                    const posData = { account_id: acc.id, symbol: 'CASH', type: 'cash', quantity: 0 };
                    const posJson = escapeHtml(JSON.stringify(posData));
                    cashRowHtml += `<td><span class="clickable-cell" style="color: #555; text-align: center;" onclick="openPositionModal(${posJson})">+</span></td>`;
                }
                totalCash += cashVal;
            });
            cashRowHtml += '<td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>';
            cashRowHtml += `<td class="row-total">${formatNumber(totalCash, 0)}</td></tr>`;
            bodyHtml += cashRowHtml;

            // Account Totals
            let totalRowHtml = '<tr class="total-row"><td>TOTAL</td>';
            let grandTotal = 0;
            accounts.forEach(acc => {
                let accTotal = 0;
                if (acc.holdings.cash) accTotal += acc.holdings.cash.value;
                acc.holdings.stocks.forEach(p => {
                    const price = currentPrices[p.symbol]?.price || 0;
                    accTotal += p.quantity * price;
                });
                acc.holdings.bonds.forEach(p => accTotal += p.quantity); // Assuming face value for bonds if no price
                grandTotal += accTotal;
                totalRowHtml += `<td>${formatNumber(accTotal)}</td>`;
            });
            let totalChangeColor = '#e0e0e0';
            if (grandTotalValueChange > 0) totalChangeColor = '#4caf50';
            if (grandTotalValueChange < 0) totalChangeColor = '#f44336';

            totalRowHtml += '<td></td><td></td><td></td><td></td><td></td>';
            totalRowHtml += `<td style="color: ${totalChangeColor}">${formatNumber(grandTotalValueChange)}</td>`;
            totalRowHtml += `<td>${formatNumber(grandTotal, 0)}</td></tr>`;
            bodyHtml += totalRowHtml;

            // Add Position Buttons
            let addRowHtml = '<tr><td></td>';
            accounts.forEach(acc => {
                 const addPosData = { account_id: acc.id, symbol: '', type: 'stock', quantity: 0 };
                 const addPosJson = escapeHtml(JSON.stringify(addPosData));
                 addRowHtml += `<td style="text-align: center;"><button class="btn btn-primary" style="padding: 2px 8px; font-size: 0.8em;" onclick="openPositionModal(${addPosJson})">Add Pos</button></td>`;
            });
            addRowHtml += '<td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>';
            bodyHtml += addRowHtml;

            tbody.innerHTML = bodyHtml;
        }

        function renderBankGrid(tableId, accounts) {
            const gridTable = document.getElementById(tableId);
            const thead = gridTable.querySelector('thead');
            const tbody = gridTable.querySelector('tbody');

            if (!accounts || accounts.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td>No bank accounts found.</td></tr>';
                return;
            }

            thead.innerHTML = `<tr>
                <th style="text-align: left">Account Name</th>
                <th style="text-align: left">Type</th>
                <th>Value</th>
            </tr>`;

            let bodyHtml = '';
            let total = 0;

            accounts.forEach(acc => {
                let val = 0;
                let cashPos = acc.holdings.cash;
                if (cashPos) val = cashPos.value;
                total += val;

                const accJson = escapeHtml(JSON.stringify(acc));
                
                let valCell = '';
                if (cashPos) {
                    const posData = { id: cashPos.id, account_id: acc.id, symbol: 'CASH', type: 'cash', quantity: val, isBankAccount: true };
                    const posJson = escapeHtml(JSON.stringify(posData));
                    valCell = `<span class="clickable-cell" onclick="openPositionModal(${posJson})">${formatNumber(val)} <span class="edit-icon">✎</span></span>`;
                } else {
                    const posData = { account_id: acc.id, symbol: 'CASH', type: 'cash', quantity: 0, isBankAccount: true };
                    const posJson = escapeHtml(JSON.stringify(posData));
                    valCell = `<span class="clickable-cell" onclick="openPositionModal(${posJson})">${formatNumber(0)} <span class="edit-icon">✎</span></span>`;
                }

                bodyHtml += `<tr>
                    <td><span class="clickable-cell" onclick="openAccountModal(null, ${accJson})">${acc.name} <span class="edit-icon">✎</span></span></td>
                    <td style="text-align: left">${acc.type}</td>
                    <td>${valCell}</td>
                </tr>`;
            });

            bodyHtml += `<tr class="total-row"><td colspan="2">TOTAL</td><td>${formatNumber(total)}</td></tr>`;
            tbody.innerHTML = bodyHtml;
        }

        function renderAssetGrid(tableId, assets) {
            const gridTable = document.getElementById(tableId);
            const thead = gridTable.querySelector('thead');
            const tbody = gridTable.querySelector('tbody');

            if (!assets || assets.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td>No fixed assets found.</td></tr>';
                return;
            }

            thead.innerHTML = `<tr>
                <th style="text-align: left">Name</th>
                <th style="text-align: left">Type</th>
                <th>Value</th>
            </tr>`;

            let bodyHtml = '';
            let total = 0;

            assets.forEach(asset => {
                total += asset.value;
                const assetJson = escapeHtml(JSON.stringify(asset));
                bodyHtml += `<tr>
                    <td><span class="clickable-cell" onclick="openAssetModal(${assetJson})">${asset.description || asset.name} <span class="edit-icon">✎</span></span></td>
                    <td style="text-align: left">${asset.type}</td>
                    <td><span class="clickable-cell" onclick="openAssetModal(${assetJson})">${formatNumber(asset.value)} <span class="edit-icon">✎</span></span></td>
                </tr>`;
            });

            bodyHtml += `<tr class="total-row"><td colspan="2">TOTAL</td><td>${formatNumber(total)}</td></tr>`;
            tbody.innerHTML = bodyHtml;
        }

        // --- Helpers ---
        function formatNumber(num, decimals = 2) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
        }

        function escapeHtml(str) {
            return str.replace(/"/g, '&quot;');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        // --- Modal Logic ---
        
        // Account
        function openAccountModal(category, account = null) {
            const modal = document.getElementById('accountModal');
            const form = document.getElementById('accountForm');
            form.reset();
            document.getElementById('accId').value = '';
            document.getElementById('accCategory').value = category || '';
            document.getElementById('btnDeleteAccount').style.display = 'none';
            document.getElementById('accountModalTitle').innerText = 'Add Account';

            if (account) {
                document.getElementById('accountModalTitle').innerText = 'Edit Account';
                document.getElementById('accId').value = account.id;
                document.getElementById('accName').value = account.name;
                document.getElementById('accType').value = account.type;
                document.getElementById('accCategory').value = account.category;
                document.getElementById('btnDeleteAccount').style.display = 'block';
            }
            modal.style.display = 'block';
        }

        document.getElementById('accountForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('accId').value;
            const body = {
                name: document.getElementById('accName').value,
                type: document.getElementById('accType').value,
                category: document.getElementById('accCategory').value
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/accounts/${id}` : '/api/accounts';

            await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            closeModal('accountModal');
            fetchAssets();
        };

        async function deleteAccount() {
            const id = document.getElementById('accId').value;
            showConfirmModal(
                'Delete Account',
                'All positions in this account will also be deleted. Are you sure?',
                async () => {
                    await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
                    closeModal('accountModal');
                    fetchAssets();
                }
            );
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').innerText = title;
            document.getElementById('confirmModalMessage').innerText = message;
            const okBtn = document.getElementById('confirmModalOk');
            // Hide any open modal (asset/account/position) before showing confirm
            const modalsToHide = ['accountModal', 'positionModal', 'assetModal'];
            let lastOpenModal = null;
            for (const mid of modalsToHide) {
                const m = document.getElementById(mid);
                if (m && m.style.display === 'block') {
                    m.style.display = 'none';
                    lastOpenModal = mid;
                }
            }
            okBtn.onclick = () => {
                closeModal('confirmModal');
                onConfirm();
            };
            // Restore the previous modal if cancel is clicked
            const cancelBtn = document.querySelector('#confirmModal .btn:not(.btn-danger)');
            cancelBtn.onclick = () => {
                closeModal('confirmModal');
                if (lastOpenModal) document.getElementById(lastOpenModal).style.display = 'block';
            };
            document.getElementById('confirmModal').style.display = 'block';
        }

        // Position
        function openPositionModal(pos) {
            const modal = document.getElementById('positionModal');
            const form = document.getElementById('positionForm');
            form.reset();
            document.getElementById('posId').value = '';
            document.getElementById('btnDeletePosition').style.display = 'none';
            document.getElementById('positionModalTitle').innerText = 'Add Position';

            document.getElementById('posAccountId').value = pos.account_id;
            document.getElementById('posSymbol').value = pos.symbol;
            document.getElementById('posType').value = pos.type;
            document.getElementById('posQuantity').value = pos.quantity;

            // Determine if this is a bank account cash position
            const isCash = pos.type === 'cash';
            const isBankCash = isCash && pos.isBankAccount;
            document.getElementById('posSymbolGroup').style.display = isCash ? 'none' : 'block';
            document.getElementById('posSymbol').required = !isCash;
            document.getElementById('posTypeGroup').style.display = isBankCash ? 'none' : 'block';
            document.getElementById('posType').disabled = isCash;
            document.getElementById('btnDeletePosition').style.display = isBankCash ? 'none' : (pos.id ? 'block' : 'none');

            if (pos.id) {
                document.getElementById('positionModalTitle').innerText = 'Edit Position';
                document.getElementById('posId').value = pos.id;
            }
            modal.style.display = 'block';
        }

        document.getElementById('positionForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('posId').value;
            const body = {
                account_id: document.getElementById('posAccountId').value,
                symbol: document.getElementById('posSymbol').value,
                type: document.getElementById('posType').value,
                quantity: parseFloat(document.getElementById('posQuantity').value),
                currency: 'USD'
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/positions/${id}` : '/api/positions';

            await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            closeModal('positionModal');
            fetchAssets();
        };

        async function deletePosition() {
            const id = document.getElementById('posId').value;
            if (!confirm('Delete this position?')) return;
            await fetch(`/api/positions/${id}`, { method: 'DELETE' });
            closeModal('positionModal');
            fetchAssets();
        }

        // Asset
        function openAssetModal(asset = null) {
            const modal = document.getElementById('assetModal');
            const form = document.getElementById('assetForm');
            form.reset();
            document.getElementById('assetId').value = '';
            document.getElementById('btnDeleteAsset').style.display = 'none';
            document.getElementById('assetModalTitle').innerText = 'Add Asset';

            if (asset) {
                document.getElementById('assetModalTitle').innerText = 'Edit Asset';
                document.getElementById('assetId').value = asset.id;
                document.getElementById('assetName').value = asset.description || asset.name;
                document.getElementById('assetType').value = asset.type;
                document.getElementById('assetValue').value = asset.value;
                document.getElementById('btnDeleteAsset').style.display = 'block';
            }
            modal.style.display = 'block';
        }

        document.getElementById('assetForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('assetId').value;
            const body = {
                name: document.getElementById('assetName').value,
                type: document.getElementById('assetType').value,
                value: parseFloat(document.getElementById('assetValue').value),
                currency: 'USD',
                display_order: 0
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/fixed_assets/${id}` : '/api/fixed_assets';

            await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            closeModal('assetModal');
            fetchAssets();
        };

        async function deleteAsset() {
            const id = document.getElementById('assetId').value;
            showConfirmModal(
                'Delete Asset',
                'Are you sure you want to delete this asset?',
                async () => {
                    await fetch(`/api/fixed_assets/${id}`, { method: 'DELETE' });
                    closeModal('assetModal');
                    fetchAssets();
                }
            );
        }

        // --- Tabs & Logs ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'Logs') {
                fetchLogs();
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const files = await response.json();
                const tbody = document.getElementById('log-list');
                tbody.innerHTML = '';
                files.forEach(file => {
                    const tr = document.createElement('tr');
                    tr.style.cursor = 'pointer';
                    tr.onclick = () => viewLog(file.name);
                    tr.onmouseover = () => tr.style.backgroundColor = '#333';
                    tr.onmouseout = () => tr.style.backgroundColor = 'transparent';

                    const date = new Date(file.timestamp).toLocaleString();
                    const size = (file.size / 1024).toFixed(1) + ' KB';

                    tr.innerHTML = `
                        <td style="padding: 5px; border-bottom: 1px solid #333; word-break: break-all;">${file.name}</td>
                        <td style="padding: 5px; border-bottom: 1px solid #333;">${date}</td>
                        <td style="padding: 5px; border-bottom: 1px solid #333; text-align: right;">${size}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        async function viewLog(filename) {
            try {
                const viewer = document.getElementById('log-viewer-pane');
                if (filename.toLowerCase().endsWith('.png')) {
                    // Display image
                    viewer.innerHTML = `<img src="/api/logs/${encodeURIComponent(filename)}" alt="${filename}" style="max-width:100%; max-height:80vh; display:block; margin:auto; background:#222; border-radius:8px;" />`;
                } else {
                    const response = await fetch(`/api/logs/${filename}`);
                    if (filename.endsWith('.json')) {
                        const data = await response.json();
                        viewer.innerText = JSON.stringify(data, null, 2);
                    } else {
                        const text = await response.text();
                        viewer.innerText = text;
                    }
                }
            } catch (error) {
                document.getElementById('log-viewer-pane').innerText = 'Error loading file: ' + error;
            }
        }

        // --- Resizing Logic ---

        // 1. Split Pane Resizer
        const paneResizer = document.getElementById('pane-resizer');
        const leftPane = document.getElementById('log-list-pane');
        const rightPane = document.getElementById('log-viewer-pane');
        const logsContainer = document.getElementById('logs-container');

        if (paneResizer) {
            let x = 0;
            let leftWidth = 0;

            const onMouseDownPane = function(e) {
                x = e.clientX;
                leftWidth = leftPane.getBoundingClientRect().width;

                document.addEventListener('mousemove', onMouseMovePane);
                document.addEventListener('mouseup', onMouseUpPane);
                
                // Visual feedback
                paneResizer.style.backgroundColor = '#666';
            };

            const onMouseMovePane = function(e) {
                const dx = e.clientX - x;
                const containerWidth = logsContainer.getBoundingClientRect().width;
                const newLeftWidth = ((leftWidth + dx) / containerWidth) * 100;
                
                // Limits (10% to 90%)
                if (newLeftWidth > 10 && newLeftWidth < 90) {
                    leftPane.style.width = `${newLeftWidth}%`;
                }

                document.body.style.cursor = 'col-resize';
                leftPane.style.userSelect = 'none';
                leftPane.style.pointerEvents = 'none';
                rightPane.style.userSelect = 'none';
                rightPane.style.pointerEvents = 'none';
            };

            const onMouseUpPane = function() {
                document.removeEventListener('mousemove', onMouseMovePane);
                document.removeEventListener('mouseup', onMouseUpPane);
                
                document.body.style.cursor = 'default';
                leftPane.style.removeProperty('user-select');
                leftPane.style.removeProperty('pointer-events');
                rightPane.style.removeProperty('user-select');
                rightPane.style.removeProperty('pointer-events');
                paneResizer.style.backgroundColor = '#444';
            };

            paneResizer.addEventListener('mousedown', onMouseDownPane);
        }

        // 2. Table Column Resizer
        function createResizableColumn(col, resizer) {
            let x = 0;
            let w = 0;

            const onMouseDownCol = function(e) {
                e.stopPropagation(); // Prevent bubbling
                x = e.clientX;
                w = col.getBoundingClientRect().width;

                document.addEventListener('mousemove', onMouseMoveCol);
                document.addEventListener('mouseup', onMouseUpCol);
                resizer.style.backgroundColor = '#888';
            };

            const onMouseMoveCol = function(e) {
                const dx = e.clientX - x;
                // Set width in pixels to override percentage
                col.style.width = `${w + dx}px`;
            };

            const onMouseUpCol = function() {
                document.removeEventListener('mousemove', onMouseMoveCol);
                document.removeEventListener('mouseup', onMouseUpCol);
                resizer.style.backgroundColor = '#555';
            };

            resizer.addEventListener('mousedown', onMouseDownCol);
        }

        // Initialize column resizers
        ['col-file'].forEach(id => {
            const th = document.getElementById(id);
            if (th) {
                const resizer = document.createElement('div');
                resizer.style.width = '5px';
                resizer.style.height = '100%';
                resizer.style.position = 'absolute';
                resizer.style.top = '0';
                resizer.style.right = '0';
                resizer.style.cursor = 'col-resize';
                resizer.style.backgroundColor = '#555'; // Visible handle
                resizer.style.userSelect = 'none';
                resizer.style.zIndex = '5';
                
                th.appendChild(resizer);
                createResizableColumn(th, resizer);
            }
        });

        // Init
        window.onload = fetchAssets;
    </script>
</body>
</html>
