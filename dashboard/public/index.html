<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Tracker Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wealth Tracker Dashboard</h1>
            <div id="net-worth-display" class="net-worth">
                Total Net Worth: <span id="total-net-worth">Loading...</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'accounts')">Accounts</button>
            <button class="tab-button" onclick="openTab(event, 'historical')">Historical Values</button>
            <button class="tab-button" onclick="openTab(event, 'projections')">Projections</button>
        </div>

        <div id="accounts" class="tab-content active">
            <section id="accounts-grid-section">
            <h2>Investment Accounts</h2>
            <div class="grid-container">
                <table id="holdings-grid">
                    <thead>
                        <!-- Headers will be generated dynamically -->
                    </thead>
                    <tbody>
                        <!-- Rows will be generated dynamically -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="bank-accounts-section">
            <h2>Bank Accounts</h2>
            <div class="grid-container">
                <table id="bank-accounts-grid">
                    <thead>
                        <!-- Headers will be generated dynamically -->
                    </thead>
                    <tbody>
                        <!-- Rows will be generated dynamically -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="other-assets-section">
            <div class="split-view">
                <div class="asset-card">
                    <h3>Real Estate</h3>
                    <ul id="real-estate-list"></ul>
                    <div class="subtotal">Total: <span id="real-estate-total">0.00</span></div>
                </div>
                <div class="asset-card">
                    <h3>Vehicles</h3>
                    <ul id="vehicles-list"></ul>
                    <div class="subtotal">Total: <span id="vehicles-total">0.00</span></div>
                </div>
            </div>
        </section>
        </div>

        <div id="historical" class="tab-content">
            <section>
                <h2>Historical Values</h2>
                <p>Coming soon...</p>
            </section>
        </div>

        <div id="projections" class="tab-content">
            <section>
                <h2>Projections</h2>
                <p>Coming soon...</p>
            </section>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";
        }

        const socket = io();
        let assetsData = null;
        let currentPrices = {};
        let previousPrices = {}; // Track previous prices for flash effect
        let activeFlashes = {}; // Track active flash states: { ticker: { flashClass, endTime } }

        // Fetch assets structure
        async function fetchAssets() {
            try {
                const response = await fetch('/api/assets');
                assetsData = await response.json();
                renderDashboard();
            } catch (error) {
                console.error('Error fetching assets:', error);
            }
        }

        // Listen for price updates
        socket.on('price_update', (prices) => {
            console.log('Received price update', prices);
            
            // Detect which tickers changed and queue flash effects
            const now = Date.now();
            for (const ticker in prices) {
                const prev = previousPrices[ticker];
                const curr = prices[ticker];
                if (prev) {
                    // Check if any relevant field changed
                    if (prev.price !== curr.price || 
                        prev.change !== curr.change || 
                        prev.change_percent !== curr.change_percent ||
                        prev.time !== curr.time ||
                        prev.source !== curr.source) {
                        // Queue a new flash for this ticker
                        const change = curr.change || 0;
                        const flashClass = parseFloat(change) >= 0 ? 'flash-positive' : 'flash-negative';
                        activeFlashes[ticker] = {
                            flashClass: flashClass,
                            endTime: now + 2000
                        };
                    }
                }
            }
            
            // Store previous prices before updating
            previousPrices = JSON.parse(JSON.stringify(currentPrices));
            currentPrices = prices;
            
            if (assetsData) {
                renderDashboard();
                // Apply flash effects after DOM update
                requestAnimationFrame(() => {
                    applyFlashEffects();
                });
            }
        });

        function applyFlashEffects() {
            const now = Date.now();
            
            // Apply all active flashes
            for (const ticker in activeFlashes) {
                const flash = activeFlashes[ticker];
                
                // Check if flash has expired
                if (now >= flash.endTime) {
                    delete activeFlashes[ticker];
                    continue;
                }
                
                const priceCell = document.querySelector(`[data-price-cell="${ticker}"]`);
                if (priceCell) {
                    // Remove any existing flash class first
                    priceCell.classList.remove('flash-positive', 'flash-negative');
                    
                    // Force reflow to restart animation
                    void priceCell.offsetWidth;
                    
                    // Add flash class
                    priceCell.classList.add(flash.flashClass);
                }
            }
            
            // Schedule cleanup of expired flashes
            setTimeout(() => {
                const now = Date.now();
                for (const ticker in activeFlashes) {
                    if (now >= activeFlashes[ticker].endTime) {
                        delete activeFlashes[ticker];
                        const priceCell = document.querySelector(`[data-price-cell="${ticker}"]`);
                        if (priceCell) {
                            priceCell.classList.remove('flash-positive', 'flash-negative');
                        }
                    }
                }
            }, 2100);
        }

        // Listen for assets updates
        socket.on('assets_update', (assets) => {
            console.log('Received assets update');
            assetsData = assets;
            renderDashboard();
        });

        function formatCurrency(value, currency = 'USD') {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function renderDashboard() {
            if (!assetsData) return;

            const allAccounts = assetsData.accounts || [];
            const bankTypes = ['checking', 'savings', 'hysa', 'cd', 'mortgage', 'credit card', 'money market'];
            
            const bankAccounts = allAccounts.filter(acc => bankTypes.includes(acc.type.toLowerCase()));
            const investmentAccounts = allAccounts.filter(acc => !bankTypes.includes(acc.type.toLowerCase()));

            renderGrid('holdings-grid', investmentAccounts);
            renderBankGrid('bank-accounts-grid', bankAccounts);

            renderOtherAssets();
            calculateNetWorth();
        }

        let currentSort = { column: 'ticker', direction: 'asc' };

        function handleSort(column) {
            if (currentSort.column === column) {
                if (column === 'ticker') {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    if (currentSort.direction === 'desc') {
                        currentSort.direction = 'asc';
                    } else {
                        currentSort.column = 'ticker';
                        currentSort.direction = 'asc';
                    }
                }
            } else {
                currentSort.column = column;
                if (column === 'ticker') {
                    currentSort.direction = 'asc';
                } else {
                    currentSort.direction = 'desc';
                }
            }
            renderDashboard();
        }

        function renderBankGrid(tableId, accounts) {
            const gridTable = document.getElementById(tableId);
            if (!gridTable) return;
            const thead = gridTable.querySelector('thead');
            const tbody = gridTable.querySelector('tbody');

            if (!accounts || accounts.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td>No accounts</td></tr>';
                return;
            }

            let headerHtml = `<tr>
                <th>Account</th>
                <th style="text-align: left">Type</th>
                <th>Value</th>
            </tr>`;
            thead.innerHTML = headerHtml;

            let bodyHtml = '';
            let grandTotal = 0;

            accounts.forEach(acc => {
                let cashValue = 0;
                if (acc.holdings && acc.holdings.cash) {
                    cashValue = acc.holdings.cash.value;
                }
                
                let totalValue = cashValue; 
                grandTotal += totalValue;

                bodyHtml += `<tr>
                    <td>${acc.name}</td>
                    <td style="text-align: left"><span class="account-type">${acc.type}</span></td>
                    <td class="row-total">${formatNumber(totalValue)}</td>
                </tr>`;
            });

            // Total Row
            bodyHtml += `<tr class="total-row">
                <td colspan="2">TOTALS</td>
                <td>${formatNumber(grandTotal)}</td>
            </tr>`;

            tbody.innerHTML = bodyHtml;
        }

        function renderGrid(tableId, accounts) {
            const gridTable = document.getElementById(tableId);
            if (!gridTable) return;
            const thead = gridTable.querySelector('thead');
            const tbody = gridTable.querySelector('tbody');

            if (!accounts || accounts.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td>No accounts</td></tr>';
                return;
            }

            // 1. Identify all unique tickers/holdings across all accounts
            const allHoldings = new Set();
            accounts.forEach(acc => {
                if (acc.holdings) {
                    if (acc.holdings.stocks) acc.holdings.stocks.forEach(s => allHoldings.add(s.ticker));
                    if (acc.holdings.bonds) acc.holdings.bonds.forEach(b => allHoldings.add(b.ticker));
                    if (acc.holdings.cash) allHoldings.add('CASH');
                }
            });

            // Prepare data for sorting
            let rowsData = Array.from(allHoldings).map(ticker => {
                let rowTotalValue = 0;
                let rowTotalShares = 0;
                let isBond = false;
                
                accounts.forEach(acc => {
                    if (acc.holdings) {
                        const stock = acc.holdings.stocks?.find(s => s.ticker === ticker);
                        const bond = acc.holdings.bonds?.find(b => b.ticker === ticker);
                        const cash = (ticker === 'CASH' && acc.holdings.cash) ? acc.holdings.cash : null;

                        if (stock) {
                            const price = currentPrices[ticker]?.price || 0;
                            rowTotalValue += stock.shares * price;
                            rowTotalShares += stock.shares;
                        } else if (bond) {
                            const price = currentPrices[ticker]?.price || 0;
                            rowTotalValue += (bond.shares * price) / 100.00;
                            rowTotalShares += bond.shares;
                            isBond = true;
                        } else if (cash) {
                            rowTotalValue += cash.value;
                        }
                    }
                });

                const priceData = currentPrices[ticker] || {};
                const change = parseFloat(priceData.change) || 0;
                const changePctStr = priceData.change_percent || '0%';
                const changePct = parseFloat(changePctStr.replace('%', '')) || 0;
                
                let valueChange = 0;
                if (ticker !== 'CASH') {
                     valueChange = isBond ? (rowTotalShares * change) / 100 : rowTotalShares * change;
                }

                return {
                    ticker,
                    totalValue: rowTotalValue,
                    changePercent: changePct,
                    valueChange: valueChange
                };
            });

            // Sort rowsData if this is the investment table
            const isInvestmentTable = tableId === 'holdings-grid';
            
            rowsData.sort((a, b) => {
                if (a.ticker === 'CASH') return 1;
                if (b.ticker === 'CASH') return -1;

                if (!isInvestmentTable) {
                     return a.ticker.localeCompare(b.ticker);
                }

                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                
                if (currentSort.column === 'ticker') {
                    return currentSort.direction === 'asc' 
                        ? valA.localeCompare(valB) 
                        : valB.localeCompare(valA);
                }

                return currentSort.direction === 'asc' ? valA - valB : valB - valA;
            });

            // 2. Build Header Row
            const isBank = tableId === 'bank-accounts-grid';
            
            const getSortHeader = (col, label) => {
                if (!isInvestmentTable) return `<th>${label}</th>`;
                let arrow = '';
                if (currentSort.column === col) {
                    arrow = currentSort.direction === 'asc' ? ' ▲' : ' ▼';
                }
                return `<th onclick="handleSort('${col}')" style="cursor:pointer; user-select: none;">${label}${arrow}</th>`;
            };

            let headerHtml = `<tr>${getSortHeader('ticker', 'Ticker')}`;
            accounts.forEach(acc => {
                headerHtml += `<th>${acc.name}<br><span class="account-type">${acc.type}</span></th>`;
            });
            if (!isBank) {
                headerHtml += `<th>Last Price</th><th>Change</th>${getSortHeader('changePercent', 'Change %')}<th>Time</th><th>Source</th>${getSortHeader('valueChange', 'Value Change')}`;
            }
            headerHtml += `${getSortHeader('totalValue', 'Total Value')}</tr>`;
            thead.innerHTML = headerHtml;

            // 3. Build Rows
            let bodyHtml = '';
            let totalValueChange = 0; 
            
            rowsData.forEach(row => {
                const ticker = row.ticker;
                let rowHtml = `<tr><td class="ticker-cell">${ticker}</td>`;
                let rowTotalValue = 0;
                let rowTotalShares = 0; 
                let isBond = false;

                accounts.forEach(acc => {
                    let cellContent = '-';
                    let holdingValue = 0;

                    if (acc.holdings) {
                        const stock = acc.holdings.stocks?.find(s => s.ticker === ticker);
                        const bond = acc.holdings.bonds?.find(b => b.ticker === ticker);
                        const cash = (ticker === 'CASH' && acc.holdings.cash) ? acc.holdings.cash : null;

                        if (stock) {
                            const price = currentPrices[ticker]?.price || 0;
                            const val = stock.shares * price;
                            holdingValue = val;
                            rowTotalShares += stock.shares;
                            cellContent = `
                                <div class="cell-data">
                                    <span class="shares">${stock.shares} sh</span>
                                    <span class="value">${formatNumber(val)}</span>
                                </div>`;
                        } else if (bond) {
                            const price = currentPrices[ticker]?.price || 0;
                            const val = (bond.shares * price) / 100.00; 
                            holdingValue = val;
                            rowTotalShares += bond.shares;
                            isBond = true;
                            cellContent = `
                                <div class="cell-data">
                                    <span class="shares">${bond.shares} units</span>
                                    <span class="value">${formatNumber(val)}</span>
                                </div>`;
                        } else if (cash) {
                            holdingValue = cash.value;
                            cellContent = `<span class="value cash">${formatNumber(cash.value)}</span>`;
                        }
                    }

                    rowTotalValue += holdingValue;
                    rowHtml += `<td>${cellContent}</td>`;
                });

                if (!isBank) {
                    const priceData = currentPrices[ticker] || {};
                    const price = priceData.price || 0;
                    const change = parseFloat(priceData.change) || 0;
                    const changePctStr = priceData.change_percent || '0%';
                    const changePctVal = parseFloat(changePctStr.replace('%', '')) || 0;
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    const time = priceData.time ? new Date(priceData.time).toLocaleString() : '-';
                    const source = priceData.source || '-';

                    if (ticker === 'CASH') {
                        rowHtml += `<td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
                    } else {
                        const valueChange = isBond ? (rowTotalShares * change) / 100 : rowTotalShares * change;
                        totalValueChange += valueChange;
                        const valueChangeClass = valueChange >= 0 ? 'positive' : 'negative';
                        
                        const displayChange = (change > 0 ? '+' : '') + change.toFixed(3);
                        const displayChangePct = (changePctVal > 0 ? '+' : '') + changePctVal.toFixed(2) + '%';

                        rowHtml += `<td data-price-cell="${ticker}">${formatNumber(price)}</td>`;
                        rowHtml += `<td class="${changeClass}">${displayChange}</td>`;
                        rowHtml += `<td class="${changeClass}">${displayChangePct}</td>`;
                        rowHtml += `<td class="time-cell">${time}</td>`;
                        rowHtml += `<td class="source-cell">${source}</td>`;
                        rowHtml += `<td class="${valueChangeClass}">${formatNumber(valueChange)}</td>`;
                    }
                }

                rowHtml += `<td class="row-total">${formatNumber(rowTotalValue)}</td></tr>`;
                bodyHtml += rowHtml;
            });

            // Add Account Totals Row
            let totalRowHtml = '<tr class="total-row"><td>ACCOUNT TOTALS</td>';
            let grandTotal = 0;
            accounts.forEach(acc => {
                let accTotal = 0;
                if (acc.holdings) {
                    if (acc.holdings.cash) accTotal += acc.holdings.cash.value;
                    if (acc.holdings.stocks) {
                        acc.holdings.stocks.forEach(s => {
                            const price = currentPrices[s.ticker]?.price || 0;
                            accTotal += s.shares * price;
                        });
                    }
                    if (acc.holdings.bonds) {
                        acc.holdings.bonds.forEach(b => {
                            const price = currentPrices[b.ticker]?.price || 0;
                            accTotal += (b.shares * price) / 100;
                        });
                    }
                }
                grandTotal += accTotal;
                totalRowHtml += `<td>${formatNumber(accTotal)}</td>`;
            });
            if (!isBank) {
                const totalValueChangeClass = totalValueChange >= 0 ? 'positive' : 'negative';
                totalRowHtml += `<td></td><td></td><td></td><td></td><td></td><td class="${totalValueChangeClass}">${formatNumber(totalValueChange)}</td>`;
            }
            totalRowHtml += `<td>${formatNumber(grandTotal)}</td></tr>`;

            bodyHtml += totalRowHtml;
            tbody.innerHTML = bodyHtml;
        }

        function renderOtherAssets() {
            // Real Estate
            const reList = document.getElementById('real-estate-list');
            let reTotal = 0;
            let reHtml = '';
            if (assetsData.real_estate) {
                assetsData.real_estate.forEach(item => {
                    reTotal += item.value;
                    reHtml += `<li><span class="desc">${item.description}</span> <span class="val">${formatCurrency(item.value, item.currency)}</span></li>`;
                });
            }
            reList.innerHTML = reHtml;
            document.getElementById('real-estate-total').textContent = formatCurrency(reTotal);

            // Vehicles
            const vList = document.getElementById('vehicles-list');
            let vTotal = 0;
            let vHtml = '';
            if (assetsData.vehicles) {
                assetsData.vehicles.forEach(item => {
                    vTotal += item.value;
                    vHtml += `<li><span class="desc">${item.description}</span> <span class="val">${formatCurrency(item.value, item.currency)}</span></li>`;
                });
            }
            vList.innerHTML = vHtml;
            document.getElementById('vehicles-total').textContent = formatCurrency(vTotal);
        }

        function calculateNetWorth() {
            let total = 0;
            
            // Real Estate
            if (assetsData.real_estate) {
                assetsData.real_estate.forEach(i => total += i.value);
            }
            // Vehicles
            if (assetsData.vehicles) {
                assetsData.vehicles.forEach(i => total += i.value);
            }
            // Accounts
            if (assetsData.accounts) {
                assetsData.accounts.forEach(acc => {
                    if (acc.holdings) {
                        if (acc.holdings.cash) total += acc.holdings.cash.value;
                        if (acc.holdings.stocks) {
                            acc.holdings.stocks.forEach(s => {
                                const price = currentPrices[s.ticker]?.price || 0;
                                total += s.shares * price;
                            });
                        }
                        if (acc.holdings.bonds) {
                            acc.holdings.bonds.forEach(b => {
                                const price = currentPrices[b.ticker]?.price || 0;
                                total += (b.shares * price) / 100;
                            });
                        }
                    }
                });
            }

            document.getElementById('total-net-worth').textContent = formatCurrency(total);
        }

        // Initial load
        fetchAssets();
    </script>
</body>
</html>
